name: Saturday Drive Backup (folders + spreadsheets)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * 6"        # Saturdays 18 UTC

jobs:
  backup:
    runs-on: ubuntu-latest

    env:
      WEEKLY_DEST_FOLDER: "1aoSe5seTsCGSn_2gDjU3SiFxlTwAFMmw"
      TRANSFERS: "10"
      CHECKERS:  "20"
      CLEAN_DEST: "0"           # set 1 → delete dated folder first

    steps:
    # ─── credentials ─────────────────────────────────────────
    - uses: actions/checkout@v3
    - name: Stage service‑account creds
      run: cp web-portal-automator-src/credentials.json ./creds.json

    # ─── rclone set‑up ───────────────────────────────────────
    - name: Install rclone
      run: curl https://rclone.org/install.sh | sudo bash

    - name: Write rclone config (Shared Drives allowed)
      run: |
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [src]
        type = drive
        scope = drive
        service_account_file = ./creds.json
        shared_with_me       = true
        drive-allow-shared-drives = true   # <─ NEW

        [dst]
        type = drive
        scope = drive
        service_account_file = ./creds.json
        root_folder_id = ${WEEKLY_DEST_FOLDER}
        drive-allow-shared-drives = true   # <─ NEW
        EOF

    # ─── copy six folder trees ───────────────────────────────
    - name: Copy folder trees (parallel)
      id: folders
      run: |
        set -e
        TODAY=$(date -u +%d.%m.%Y)
        DEST="dst:${TODAY}"

        if [ "$CLEAN_DEST" = "1" ]; then
          rclone purge "$DEST" --drive-use-trash=false --drive-allow-shared-drives
        fi
        rclone mkdir "$DEST" --drive-allow-shared-drives

        FOLDERS=(
          16VQxSSw_Zybv7GtFMhQgzyzyE5EEX9gb
          10lXwcwYGsbdIYLhkL9862RP4Xi1L-p9v
          17O23nAlgh2fnlBcIBmk2K7JBeUAAQZfB
          1-sVtj8AdMB7pQAadjB9_CUmQ67gOXswi
          1g6FARH-wKNk9o0s74X60cifwcc6YDqoP
          1GSWRpzm9OMNQF7Wbcgr7cLE5zX8gPEbO
        )

        for ID in "${FOLDERS[@]}"; do
          rclone copy \
            --drive-allow-shared-drives \
            --drive-shared-with-me \
            --drive-chunk-size 64M \
            --transfers ${TRANSFERS} \
            --checkers  ${CHECKERS} \
            --drive-use-trash=false \
            --create-empty-src-dirs \
            "src:{${ID}}" \
            "$DEST/$ID" &
        done
        wait
        echo "folders_done=1" >> "$GITHUB_OUTPUT"

    # ─── copy seven spreadsheets (unchanged) ─────────────────
    - uses: actions/setup-python@v4
      if: steps.folders.outputs.folders_done == '1'
      with:
        python-version: "3.10"

    - name: Install Google client
      if: steps.folders.outputs.folders_done == '1'
      run: |
        python -m pip install --upgrade pip
        python -m pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

    - name: Copy 7 standalone spreadsheets
      if: steps.folders.outputs.folders_done == '1'
      working-directory: web-portal-automator-src
      run: python weekly_backup_files.py

    - name: Finished
      run: echo "✅ Weekly Drive backup finished (folders + spreadsheets)."
