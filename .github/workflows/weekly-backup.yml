# .github/workflows/weekly-backup.yml

name: Saturday Drive Backup via rclone

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * 6"   # Saturdays 18:00 UTC

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Copy credentials.json locally
        run: cp web-portal-automator-src/credentials.json ./creds.json

      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Write rclone config
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [src]
          type = drive
          scope = drive
          service_account_file = ./creds.json

          [dst]
          type = drive
          scope = drive
          service_account_file = ./creds.json
          root_folder_id = 1aoSe5seTsCGSn_2gDjU3SiFxlTwAFMmw
          EOF

      - name: Run rclone copy in parallel
        env:
          TRANSFERS: 5
          CHECKERS: 8
        run: |
          set -e

          TODAY=$(date -u +%d.%m.%Y)
          DEST="dst:$TODAY"

          # ensure the dated folder exists
          rclone mkdir $DEST

          # list of folder IDs to back up
          FOLDERS=(
            16VQxSSw_Zybv7GtFMhQgzyzyE5EEX9gb
            17O23nAlgh2fnlBcIBmk2K7JBeUAAQZfB
            1g6FARH-wKNk9o0s74X60cifwcc6YDqoP
            1GSWRpzm9OMNQF7Wbcgr7cLE5zX8gPEbO
          )

          # back up each folder (tree) in its own background job
          for F in "${FOLDERS[@]}"; do
            rclone copy \
              --drive-chunk-size 64M \
              --transfers $TRANSFERS \
              --checkers $CHECKERS \
              --create-empty-src-dirs \
              "src:$F" \
              "$DEST/$F" &
          done

          # list of single file IDs to back up
          FILES=(
            1zvHfXlJ_U1ra6itGwjVy2O1_N-uDJn9xmEuen7Epk1M
            1P6A405z9-zy_QAEihk0tdsdvFGssQ26f79IJO6cgjD4
            1x-XkSVBSprrZWMNJKAxEI2S2QfqIhU50GMuHXTGyPx4
            1inqfbzosNG6Xf8AxJEJH8yoSLJy3b6_7c8cqy1yXq6s
            1cE-eC__yz6bz931D3DyFj-ZyzJGIx-Ta
            1HhMiTjrFYqgl33IcFS2X1gAtAW42hVCIxLMd6UVUjN8
            1JESHGsBdVLEqCiLssy7ZZ12S6V-0mZMc
          )

          # back up each single file
          for F in "${FILES[@]}"; do
            rclone copy \
              --drive-chunk-size 64M \
              --transfers $TRANSFERS \
              --checkers $CHECKERS \
              "src:$F" \
              "$DEST/" &
          done

          # wait for all copies
          wait

          echo "âœ… Weekly backup via rclone complete!"
