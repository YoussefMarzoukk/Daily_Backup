name: Saturday Drive Backup (rclone + Python)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * 6"  # Saturdays 18:00 UTC

jobs:
  backup:
    runs-on: ubuntu-latest

    env:
      WEEKLY_DEST_FOLDER: "1aoSe5seTsCGSn_2gDjU3SiFxlTwAFMmw"
      TRANSFERS: 5
      CHECKERS: 8

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Copy credentials.json locally
        run: cp web-portal-automator-src/credentials.json ./creds.json

      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Write rclone config
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [src]
          type = drive
          scope = drive
          service_account_file = ./creds.json

          [dst]
          type = drive
          scope = drive
          service_account_file = ./creds.json
          root_folder_id = ${WEEKLY_DEST_FOLDER}
          EOF

      - name: Run rclone folder backup
        run: |
          set -e
          TODAY=$(date -u +%d.%m.%Y)
          DEST="dst:$TODAY"
          rclone mkdir $DEST

          # backup 4 large folders in parallel
          FOLDERS=(
            16VQxSSw_Zybv7GtFMhQgzyzyE5EEX9gb
            17O23nAlgh2fnlBcIBmk2K7JBeUAAQZfB
            1g6FARH-wKNk9o0s74X60cifwcc6YDqoP
            1GSWRpzm9OMNQF7Wbcgr7cLE5zX8gPEbO
          )
          for F in "${FOLDERS[@]}"; do
            rclone copy \
              --drive-chunk-size 64M \
              --transfers ${TRANSFERS} \
              --checkers ${CHECKERS} \
              --drive-use-trash=false \
              --create-empty-src-dirs \
              "src:$F" \
              "$DEST/$F" &
          done
          wait
          echo "âœ… Folder trees backed up via rclone."

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Google API client
        run: |
          python -m pip install --upgrade pip
          python -m pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Run spreadsheet backup
        working-directory: web-portal-automator-src
        run: python weekly_backup_files.py
