# .github/workflows/weekly-backup.yml

name: Saturday Drive Backup via rclone

on:
  workflow_dispatch:         # manual trigger
  schedule:
    - cron: "0 18 * * 6"     # every Saturday at 18:00 UTC (19:00 CET / 20:00 CEST)

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Expose service-account credentials
        # we assume credentials.json is in web-portal-automator-src/
        run: |
          cp web-portal-automator-src/credentials.json ./creds.json

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Configure rclone remotes
        run: |
          # src will point at your source Drive
          rclone config create src drive \
            service_account_file creds.json \
            token '{}' \
            scope drive \
            root_folder_id 16VQxSSw_Zybv7GtFMhQgzyzyE5EEX9gb

          # dst will point at your backup Drive parent folder
          rclone config create dst drive \
            service_account_file creds.json \
            token '{}' \
            scope drive \
            root_folder_id 1aoSe5seTsCGSn_2gDjU3SiFxlTwAFMmw

      - name: Run rclone copy
        env:
          TRANSFERS: 5     # number of parallel file transfers
          CHECKERS: 8      # number of parallel directory scans
        run: |
          TODAY=$(date -u +%d.%m.%Y)
          DEST="dst:$TODAY"

          # ensure the dated folder exists
          rclone mkdir $DEST

          # copy Folder #1 (and everything under it)
          rclone copy \
            src: \
            $DEST/16VQxSSw_Zybv7GtFMhQgzyzyE5EEX9gb \
            --drive-chunk-size 64M \
            --transfers $TRANSFERS \
            --checkers $CHECKERS \
            --drive-use-trash=false \
            --create-empty-src-dirs

          # copy Folder #2
          rclone copy \
            src:17O23nAlgh2fnlBcIBmk2K7JBeUAAQZfB \
            $DEST/17O23nAlgh2fnlBcIBmk2K7JBeUAAQZfB \
            --drive-chunk-size 64M \
            --transfers $TRANSFERS \
            --checkers $CHECKERS \
            --drive-use-trash=false

          echo "âœ… Weekly rclone backup complete!"
